# =============================================================
# paas-boilerplate — Full Stack Docker Compose
# =============================================================
# Core (API + Dashboard + DB)  → always runs
# Site (Marketing)             → always runs
# Docs (Documentation)         → always runs
# Supabase                     → external (cloud or self-hosted)
# =============================================================
#
# Usage:
#   docker compose up -d              # start all services
#   docker compose up -d --build      # rebuild & start
#   docker compose down               # stop all
#   docker compose down -v            # stop + remove volumes
#   docker compose logs -f api        # follow API logs
# =============================================================

services:
  # ─────────────────────────────────────────────
  # Database
  # ─────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DATABASE_USER:-paas}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-paas}
      POSTGRES_DB: ${DATABASE_NAME:-paas}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${DATABASE_PORT:-5432}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DATABASE_USER:-paas}" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # ─────────────────────────────────────────────
  # Go REST API
  # ─────────────────────────────────────────────
  api:
    build:
      context: ./paas-core
      dockerfile: deploy/docker/Dockerfile.api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8080}:8080"
    environment:
      # Database
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_USER: ${DATABASE_USER:-paas}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-paas}
      DATABASE_NAME: ${DATABASE_NAME:-paas}
      DATABASE_SSLMODE: disable
      # Auth
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      # Server
      SERVER_PORT: "8080"
      APP_ENVIRONMENT: ${APP_ENVIRONMENT:-development}
      APP_NAME: ${APP_NAME:-PaaS}
      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:4321,http://localhost:3001}
      CORS_ALLOW_CREDENTIALS: "true"
      # Email
      EMAIL_API_KEY: ${EMAIL_API_KEY:-re_test}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@localhost}
      # Xendit
      XENDIT_SECRET_KEY: ${XENDIT_SECRET_KEY:-}
      XENDIT_WEBHOOK_TOKEN: ${XENDIT_WEBHOOK_TOKEN:-}
      # OAuth
      OAUTH_FRONTEND_URL: ${OAUTH_FRONTEND_URL:-http://localhost:3000}
      # Supabase (connect to external instance — cloud or self-hosted)
      SUPABASE_ENABLED: ${SUPABASE_ENABLED:-false}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY:-}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET:-}
      SUPABASE_WEBHOOK_SECRET: ${SUPABASE_WEBHOOK_SECRET:-}
    depends_on:
      postgres:
        condition: service_healthy

  # ─────────────────────────────────────────────
  # Next.js Dashboard
  # ─────────────────────────────────────────────
  web:
    build:
      context: ./paas-core
      dockerfile: deploy/docker/Dockerfile.web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
      NEXT_PUBLIC_APP_NAME: ${NEXT_PUBLIC_APP_NAME:-MyPaaS}
      NEXT_PUBLIC_AUTH_PROVIDER: ${NEXT_PUBLIC_AUTH_PROVIDER:-local}
      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:-}
    depends_on:
      - api

  # ─────────────────────────────────────────────
  # Astro Marketing Site
  # ─────────────────────────────────────────────
  site:
    build:
      context: ./paas-site
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${SITE_PORT:-4321}:80"

  # ─────────────────────────────────────────────
  # Fumadocs Documentation
  # ─────────────────────────────────────────────
  docs:
    build:
      context: ./paas-docs
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${DOCS_PORT:-3001}:3000"

volumes:
  pgdata:
